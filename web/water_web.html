<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水利工程监控系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="container mt-4">

    <h2 class="text-center">水利工程数据可视化与监控系统</h2>

    <!-- 水位警报区域 -->
    <div id="alert-box" class="alert alert-danger d-none" role="alert">
        <strong>警告！</strong> 水位超标，请立即检查！
    </div>

    <!-- 图表区域 -->
    <div class="row">
        <div class="col-md-6">
            <canvas id="waterLevelChart"></canvas>
        </div>
        <div class="col-md-6">
            <canvas id="temperatureChart"></canvas>
        </div>
        <div class="col-md-6">
            <canvas id="humidityChart"></canvas>
        </div>
        <div class="col-md-6">
            <canvas id="windPowerChart"></canvas>
        </div>
    </div>

    <!-- 历史数据表格 -->
    <h3 class="mt-4">历史数据</h3>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>时间</th>
                <th>水位 (m)</th>
                <th>温度 (℃)</th>
                <th>湿度 (%)</th>
                <th>风速 (m/s)</th>
            </tr>
        </thead>
        <tbody id="history-table">
            <!-- 数据将由JS填充 -->
        </tbody>
    </table>

    <!-- DeepSeek AI 查询模块 -->
    <h3>智能分析</h3>
    <textarea id="deepseek-question" class="form-control" rows="3" placeholder="请输入您的问题"></textarea>
    <button class="btn btn-primary mt-2" onclick="askDeepSeek()">查询</button>
    <div class="mt-3 p-2 border" id="deepseek-result">等待输入...</div>

    <script>
        async function fetchData() {
            const response = await fetch('/data');
            const data = await response.json();

            // 获取最新的数据点
            const latest = data[data.length - 1];

            // 更新警报（如果水位超过 85.45m）
            document.getElementById("alert-box").classList.toggle("d-none", latest.water_level <= 85.45);

            // 更新图表
            updateChart(waterLevelChart, data.map(d => d.timestamp), data.map(d => d.water_level));
            updateChart(temperatureChart, data.map(d => d.timestamp), data.map(d => d.temperature));
            updateChart(humidityChart, data.map(d => d.timestamp), data.map(d => d.humidity));
            updateChart(windPowerChart, data.map(d => d.timestamp), data.map(d => d.windpower));

            // 更新历史数据表格
            let tableHTML = "";
            data.slice(-10).forEach(row => {
                tableHTML += `<tr>
                    <td>${row.timestamp}</td>
                    <td>${row.water_level}</td>
                    <td>${row.temperature}</td>
                    <td>${row.humidity}</td>
                    <td>${row.windpower}</td>
                </tr>`;
            });
            document.getElementById("history-table").innerHTML = tableHTML;
        }

        function updateChart(chart, labels, data) {
            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            chart.update();
        }

        async function askDeepSeek() {
            const question = document.getElementById("deepseek-question").value;
            const response = await fetch('/deepseek', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question })
            });
            const result = await response.json();
            document.getElementById("deepseek-result").innerText = result.answer;
        }

        // 初始化图表
        const chartOptions = { responsive: true, maintainAspectRatio: false };
        const waterLevelChart = new Chart(document.getElementById("waterLevelChart"), { type: "line", data: { labels: [], datasets: [{ label: "水位 (m)", borderColor: "blue", data: [] }] }, options: chartOptions });
        const temperatureChart = new Chart(document.getElementById("temperatureChart"), { type: "line", data: { labels: [], datasets: [{ label: "温度 (℃)", borderColor: "red", data: [] }] }, options: chartOptions });
        const humidityChart = new Chart(document.getElementById("humidityChart"), { type: "line", data: { labels: [], datasets: [{ label: "湿度 (%)", borderColor: "green", data: [] }] }, options: chartOptions });
        const windPowerChart = new Chart(document.getElementById("windPowerChart"), { type: "line", data: { labels: [], datasets: [{ label: "风速 (m/s)", borderColor: "purple", data: [] }] }, options: chartOptions });

        setInterval(fetchData, 5000);  // 每5秒刷新数据
    </script>

</body>

</html>